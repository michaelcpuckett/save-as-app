<!DOCTYPE html>
<meta
  name="viewport"
  content="width=device-width, initial-scale=1, viewport-fit=cover"
/>
<meta
  name="description"
  content="Open any website in a standalone window on iPhone or iPad, instead of Safari."
/>
<meta name="mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-capable" content="yes" />

<style>
  :root:not(:has(h1)) {
    & footer {
      display: none;
    }
  }

  :root:has(h1) {
    color-scheme: dark;
    height: 100%;
    font-size: 24px;

    & body {
      font-family: sans-serif;
      display: grid;
      line-height: 1.4;
      place-items: center;
      place-content: center;
      height: max-content;
      min-height: 100%;
      margin: 0;
      background: #242426;
    }

    & a {
      color: deepskyblue;
    }

    & h1 {
      font-size: 1rem;
    }

    & form {
      position: relative;
      box-sizing: border-box;
      display: grid;
      gap: 1rem;
      width: min(100% - 2rem, 20rem);
      border: 0.1rem solid #4c4b4b;
      border-radius: 2rem;
      margin: 2rem auto;
      overflow: hidden;
      padding: 2rem;
      padding-top: calc(2rem + 18px);
    }

    & form:before {
      position: absolute;
      content: "";
      left: 0;
      right: 0;
      height: 18px;
      background: #4c4b4b;
    }

    & form:after {
      position: absolute;
      content: "";
      left: 0;
      right: 0;
      top: 4px;
      height: 8px;
      background: url("handle-buttons.svg");
      background-repeat: no-repeat;
      background-position: center center;
    }

    & h2 {
      margin: 0;
      font-size: 1rem;
    }

    & input {
      font-size: 0.75rem;
      border: 0.1rem solid #4c4b4b;
      width: 100%;
      display: block;
      padding: 0.5rem;
      border-radius: 0.5rem;
      box-sizing: border-box;
    }

    & input[type="file"] {
      align-items: center;
      justify-content: center;
      display: flex;
    }

    & label {
      font-size: 0.75rem;
      font-weight: bold;
      display: grid;
      width: 100%;
      gap: 0.25rem;
    }

    & p {
      font-size: 0.75rem;
    }

    & button {
      font: unset;
      font-size: 1rem;
      padding: 0.5rem;
      border: 0.1rem solid #4c4b4b;
      border-radius: 0.5rem;
      cursor: pointer;
      font-weight: bold;
      color: Canvas;
      background: deepskyblue;
    }

    & footer {
      width: min(100% - 2rem, 20rem);
      margin-bottom: 2rem;
    }

    & .instructions {
      --margin-value: calc(50vh - 0.5rem * 1.4);
      margin-top: var(--margin-value);
      margin-top: var(--margin-value);
      margin-bottom: var(--margin-value);
      margin-bottom: var(--margin-value);
    }
  }
</style>
<body>
  <script>
    function handleNavigation() {
      if (window.location.href.includes("?url=")) {
        const metaRefreshEl = window.document.createElement("meta");
        metaRefreshEl.setAttribute("http-equiv", "refresh");
        metaRefreshEl.setAttribute(
          "content",
          `0;url=${window.location.href.split("?url=")[1]}`
        );
        window.document.head.append(metaRefreshEl);
      } else {
        const priorIconLinkEl = window.document.querySelector(
          "link[rel='apple-touch-icon']"
        );

        if (priorIconLinkEl) {
          priorIconLinkEl.remove();
        }

        const priorManifestLinkEl = window.document.querySelector(
          "link[rel='manifest']"
        );

        if (priorManifestLinkEl) {
          priorManifestLinkEl.remove();
        }

        const priorH1El = window.document.querySelector("h1");

        if (priorH1El) {
          priorH1El.remove();
        }

        window.document.title = "save-as.app";

        const iconLinkEl = window.document.createElement("link");
        iconLinkEl.setAttribute("rel", "apple-touch-icon");

        // <form>
        const formEl = window.document.createElement("form");

        // <form> <h1>
        const h1El = window.document.createElement("h1");

        // <form> <h1> <a>
        const h1AnchorEl = window.document.createElement("a");
        h1AnchorEl.textContent = "save-as.app";
        h1AnchorEl.setAttribute("href", window.location.href);

        // <form> <h2>
        const h2El = window.document.createElement("h2");
        h2El.textContent =
          "Open any website in a standalone window on iPhone or iPad, instead of Safari.";

        // <form> <label>
        const nameInputLabel = window.document.createElement("label");
        nameInputLabel.textContent = "Title*";

        // <form> <label>
        const fileInputLabel = window.document.createElement("label");
        fileInputLabel.textContent = "Icon";

        // <form> <label>
        const urlInputLabel = window.document.createElement("label");
        urlInputLabel.textContent = "URL*";

        // <form> <button>
        const buttonEl = window.document.createElement("button");
        buttonEl.textContent = "Next";

        // <form> <label> <input type="text">
        const nameInputEl = window.document.createElement("input");
        nameInputEl.setAttribute("placeholder", "My Web App");
        nameInputEl.setAttribute("type", "text");
        nameInputEl.setAttribute("required", "");

        // <form> <label> <input type="file">
        const fileInputEl = window.document.createElement("input");
        fileInputEl.setAttribute("type", "file");
        fileInputEl.addEventListener("change", () => {
          const file = fileInputEl.files[0];
          const reader = new FileReader();

          reader.addEventListener("load", () => {
            iconLinkEl.href = reader.result;
          });

          if (file) {
            // Convert image file to base64 string.
            reader.readAsDataURL(file);
          }
        });

        // <form> <label> <input type="url">
        const urlInputEl = window.document.createElement("input");
        urlInputEl.setAttribute("placeholder", "http link to website");
        urlInputEl.setAttribute("type", "url");
        urlInputEl.setAttribute("required", "");

        // <form> <p>
        const paragraphEl = window.document.createElement("p");
        paragraphEl.textContent =
          'On the next screen, hit the share icon, then select "Add to Home Screen" from the share sheet.';

        formEl.addEventListener("submit", (event) => {
          event.preventDefault();
          if (urlInputEl.value) {
            const startUrl = `/?url=${urlInputEl.value}`;
            const manifestDataUri = `data:application/manifest+json;charset=utf-8,${encodeURIComponent(
              JSON.stringify({
                name: nameInputEl.value || "",
                short_name: nameInputEl.value || "",
                start_url: startUrl,
                display: "standalone",
                background_color: "#000000",
                theme_color: "#000000",
              })
            )}`;

            const manifestLinkEl = window.document.createElement("link");
            manifestLinkEl.setAttribute("rel", "manifest");
            manifestLinkEl.setAttribute("href", manifestDataUri);

            const h1El = window.document.createElement("h1");
            h1El.textContent = "Add to Home Screen";
            h1El.classList.add("instructions");

            window.history.pushState({}, "", startUrl);

            if (iconLinkEl.href) {
              window.document.head.append(iconLinkEl);
            }

            if (nameInputEl.value) {
              window.document.title = nameInputEl.value;
            }

            window.document.head.append(manifestLinkEl);
            formEl.remove();
            window.document.body.prepend(h1El);

            window.scrollTo(0, 0);
          }
        });

        h1El.append(h1AnchorEl);

        nameInputLabel.append(nameInputEl);
        fileInputLabel.append(fileInputEl);
        urlInputLabel.append(urlInputEl);

        formEl.append(h1El);
        formEl.append(h2El);
        formEl.append(nameInputLabel);
        formEl.append(fileInputLabel);
        formEl.append(urlInputLabel);
        formEl.append(buttonEl);
        formEl.append(paragraphEl);

        window.document.body.prepend(formEl);
      }
    }

    handleNavigation();

    window.addEventListener("popstate", handleNavigation);
  </script>
  <footer>
    <h2>How does this work?</h2>
    <p>
      Web browsers look for a `manifest.json` file to determine whether a
      website is a Progressive Web App. This file contains metadata about the
      app, including its name, icon, and URL. This website generates a
      `manifest.json` file, configured to launch as a standalone app that opens
      in a separate window on iPhone and iPad.
    </p>
    <p>
      This website is open source. You can view the source code on
      <a href="https://www.github.com/michaelcpuckett/standalone-web-wrapper"
        >Github</a
      >.
    </p>
  </footer>
</body>
